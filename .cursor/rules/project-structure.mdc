---
alwaysApply: false
---
# Project Context: CaddyAI (macOS Voice-to-LLM Assistant)

You are an expert Senior Swift Engineer and Python Backend Developer. You are working on a hybrid application consisting of a native macOS frontend (SwiftUI) and an agentic Python backend (FastAPI).

## 1. Project Structure

### Root Directory
- **backend/**: Python FastAPI backend.
- **caddyAI/**: Native macOS application (Swift).
- **caddyAI.xcodeproj**: Xcode project file.

### Backend (`backend/`)
- **main.py**: FastAPI entry point.
- **agent_service.py**: Core agent logic (Gemini + Composio).
- **debug_tools.py**: Debugging utilities.
- **requirements.txt** / **pyproject.toml**: Dependencies.

### Frontend (`caddyAI/`)
- **App Entry**: `HexBubbleApp.swift`, `AppDelegate.swift`.
- **Models/**: `ChatModels.swift` (Shared data models).
- **ViewModels/**: `AgentViewModel.swift` (State management).
- **Views/**:
  - `CaddyView.swift`: Main container.
  - `VoiceChatBubble.swift`: Primary floating UI.
  - `ConfirmationCardView.swift`: Action confirmation UI.
  - **Components/**: `ToolStatusView.swift`.
- **Services/**:
  - `LLMService.swift`: Networking with Python backend.
  - `AudioCaptureService.swift` / `VoiceRecorder.swift`: Audio handling.
  - `GlobalKeyMonitor.swift` / `HotkeyManager.swift`: Input handling.
- **Transcription/**:
  - `ParakeetTranscriptionService.swift`: Local transcription logic.

## 2. Critical Technical Constraints

### Frontend (macOS)
- **Transcription Engine:** STRICTLY use `FluidAudio` library with the **Parakeet TDT v3** model.
- **Forbidden Libraries:** DO NOT suggest, import, or use `WhisperKit`, `SFSpeechRecognizer`, or `Speech`.
- **Audio Format:** Parakeet requires 16kHz PCM float. Ensure `ParakeetTranscriptionService` converts audio to this format before processing.
- **Platform:** macOS 14+ only. Use modern Swift 5.9+ concurrency (`async/await`).
- **Networking:** Communicate with backend via `LLMService` (REST/Streaming).

### Backend (Python)
- **Framework:** FastAPI.
- **Agent:** Google Gemini via `google-generativeai`.
- **Tools:** Composio for external integrations (Linear, etc.).

## 3. Architecture & State Management
- **State Machine:** The app is driven by `VoiceChatState` (idle, recording, processing, success, chat).
- **Data Flow:** Voice -> Transcription -> Text -> Backend (LLM) -> Action/Response -> Frontend UI.
- **View Hierarchy:**
  - Use a `ZStack(alignment: .bottomTrailing)` to anchor animations.
  - Use `.matchedGeometryEffect(id: "background")` for morphing transitions.
  - **Anti-Ghosting:** The Pill and Chat window must be mutually exclusive.

## 4. The "Glassmorphism" Design System
Mimic the "Hex" app aesthetic. Apply these modifiers to main backgrounds:
- **Material:** `.ultraThinMaterial` with `.black.opacity(0.5)` tint.
- **Rim Lighting (Border):** 1px stroke using `LinearGradient` (Top-Left White @ 0.3 opacity → Bottom-Right Clear).
- **Shadows:** Diffuse black shadow (radius: 15, y: 10).
- **Typography:** San Francisco system fonts.

## 5. Window Layout & Resizing Logic (DO NOT BREAK)
The `ExpandedChatView` uses a custom "Grow-to-fit" mechanism.
**Do not refactor this into a standard List/ScrollView.**

- **The Mechanism:**
  1. A `GeometryReader` measures the inner content height (`contentHeight`).
  2. The Window Frame is clamped: `.frame(height: min(max(contentHeight + padding, 140), 600))`.
  3. **Scroll Hack:** The `ScrollView` must have `.scrollDisabled(contentHeight < 600)`.

## 6. Key Components
- **VoiceRecorder:** Uses `AVAudioRecorder` saving to `NSTemporaryDirectory`.
- **GlobalKeyMonitor:** Listens for `NSEvent` flags. Detects Double-Tap Command (⌘) (< 0.3s) to toggle visibility.
- **AgentViewModel:** Central hub for UI state and logic.
- **LLMService:** Handles all HTTP/Streaming communication with `http://127.0.0.1:8000`.

## 7. Coding Style
- Use `final class` for services and ViewModels.
- Prefer struct-based Views.
- Use `@MainActor` for UI-related updates.
- When modifying `ParakeetTranscriptionService`, ensure lazy loading of the model.
